---
interface MenuItem {
  name: string;
  description: string;
  price_crc: number;
}

interface MenuCategory {
  name: string;
  items: MenuItem[];
}

interface Props {
  menuData: {
    categories: MenuCategory[];
  };
}

const { menuData } = Astro.props;
const USD_RATE = 515;
---

<div class="menu-container">
  <!-- Navegación de categorías (tabs horizontales) -->
  <nav class="category-nav" aria-label="Categorías del menú">
    <div class="nav-wrapper">
      <div class="category-tabs-container">
        <div class="category-tabs-scroll">
          {menuData.categories.map((category, index) => (
            <button
              class={`category-tab ${index === 0 ? 'active' : ''}`}
              data-category={index}
              aria-expanded={index === 0}
              aria-controls={`category-${index}`}
            >
              <span class="tab-content">
                <span class="tab-text">{category.name}</span>
                <span class="items-count">({category.items.length})</span>
                {index === 0 && (
                  <span class="active-indicator" aria-hidden="true"></span>
                )}
              </span>
            </button>
          ))}
        </div>
        <div class="nav-shadow right"></div>
      </div>
    </div>
  </nav>

  <!-- Indicador de categoría activa -->
  <div class="active-category-indicator"></div>

  <!-- Contenido de categorías -->
  <div class="categories-content">
    {menuData.categories.map((category, categoryIndex) => (
      <section
        class={`category-section ${categoryIndex === 0 ? 'active' : ''}`}
        data-category-content={categoryIndex}
        id={`category-${categoryIndex}`}
        aria-labelledby={`tab-${categoryIndex}`}
        role="tabpanel"
      >
        <div class="category-header">
          <div class="category-decoration">
            <span class="decoration-line"></span>
            <div class="category-title-wrapper">
              <h2 class="category-title">{category.name}</h2>
              <span class="category-badge">{category.items.length} ítems</span>
            </div>
            <span class="decoration-line"></span>
          </div>
        </div>

        <div class="menu-items-grid">
          {category.items.map((item, itemIndex) => (
            <article 
              class="menu-item-card" 
              data-item-index={itemIndex}
              itemscope 
              itemtype="http://schema.org/MenuItem"
            >
              <div class="card-header" itemprop="name">
                <h3 class="item-name">{item.name}</h3>
                <div class="item-price-group" itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                  <div class="price-main">
                    <span class="item-price-crc" itemprop="price" content={(item.price_crc/100).toFixed(2)}>
                      ₡{item.price_crc.toLocaleString('es-CR')}
                    </span>
                    <meta itemprop="priceCurrency" content="CRC" />
                  </div>
                  <div class="price-alt">
                    <span class="item-price-usd">
                      ${(item.price_crc / USD_RATE).toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>
              <p class="item-description" itemprop="description">{item.description}</p>
              <div class="item-footer">
                <div class="popular-badge">
                  <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  <span>Más popular</span>
                </div>
                <button class="add-to-order" aria-label={`Añadir ${item.name} al pedido`}>
                  <svg class="plus-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>
            </article>
          ))}
        </div>
      </section>
    ))}
  </div>
</div>

<script>
  // Navegación entre categorías mejorada
  const tabs = document.querySelectorAll('.category-tab');
  const sections = document.querySelectorAll('.category-section');
  const activeIndicator = document.querySelector('.active-category-indicator');

  // Función para actualizar indicador visual
  function updateActiveIndicator(activeTab) {
    if (!activeIndicator || !activeTab) return;
    
    const tabRect = activeTab.getBoundingClientRect();
    const navRect = activeTab.closest('.nav-wrapper').getBoundingClientRect();
    
    activeIndicator.style.left = `${tabRect.left - navRect.left}px`;
    activeIndicator.style.width = `${tabRect.width}px`;
    activeIndicator.style.opacity = '1';
  }

  // Inicializar indicador
  const initialActiveTab = document.querySelector('.category-tab.active');
  if (initialActiveTab) {
    setTimeout(() => updateActiveIndicator(initialActiveTab), 100);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const categoryIndex = tab.getAttribute('data-category');

      // Actualizar tabs activos
      tabs.forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-expanded', 'false');
      });
      tab.classList.add('active');
      tab.setAttribute('aria-expanded', 'true');

      // Actualizar indicador visual
      updateActiveIndicator(tab);

      // Actualizar secciones activas
      sections.forEach(section => {
        if (section.getAttribute('data-category-content') === categoryIndex) {
          section.classList.add('active');
          // Scroll suave a la sección
          section.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
            inline: 'nearest'
          });
          
          // Añadir animación de entrada
          section.style.animation = 'fadeInSlideUp 0.4s ease-out';
        } else {
          section.classList.remove('active');
        }
      });
    });
  });

  // Scroll para detectar cambio automático de categoría
  let isScrolling = false;
  const categoriesContent = document.querySelector('.categories-content');

  if (categoriesContent) {
    categoriesContent.addEventListener('scroll', () => {
      if (isScrolling) return;
      
      isScrolling = true;
      setTimeout(() => {
        const scrollPosition = categoriesContent.scrollTop + 100;
        
        sections.forEach((section, index) => {
          const sectionTop = section.offsetTop;
          const sectionBottom = sectionTop + section.offsetHeight;
          
          if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
            const correspondingTab = tabs[index];
            if (correspondingTab && !correspondingTab.classList.contains('active')) {
              tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-expanded', 'false');
              });
              correspondingTab.classList.add('active');
              correspondingTab.setAttribute('aria-expanded', 'true');
              updateActiveIndicator(correspondingTab);
            }
          }
        });
        isScrolling = false;
      }, 150);
    });
  }

  // Animaciones para items del menú
  const menuItems = document.querySelectorAll('.menu-item-card');
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.animationDelay = `${entry.target.dataset.itemIndex * 0.1}s`;
        entry.target.classList.add('animated');
      }
    });
  }, observerOptions);

  menuItems.forEach(item => observer.observe(item));

  // Botones para añadir al pedido
  document.querySelectorAll('.add-to-order').forEach(button => {
    button.addEventListener('click', function() {
      const menuItem = this.closest('.menu-item-card');
      const itemName = menuItem.querySelector('.item-name').textContent;
      
      // Animación de feedback
      this.style.transform = 'scale(0.9)';
      this.style.backgroundColor = '#10b981';
      
      setTimeout(() => {
        this.style.transform = 'scale(1)';
        setTimeout(() => {
          this.style.backgroundColor = '';
        }, 300);
      }, 150);
      
      // Notificación (podría integrarse con un sistema de pedidos)
      console.log(`Añadido al pedido: ${itemName}`);
    });
  });
</script>

<style>
  .menu-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #fffaf0 0%, #fff 100%);
    position: relative;
    overflow: hidden;
  }

  /* Navegación de categorías - Mejorada */
  .category-nav {
    position: sticky;
    top: 0;
    z-index: 50;
    background: linear-gradient(to bottom, #fff 85%, rgba(255, 255, 255, 0.8));
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(245, 158, 11, 0.1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .nav-wrapper {
    position: relative;
    padding: 0 1rem;
  }

  .category-tabs-container {
    position: relative;
    overflow: hidden;
  }

  .category-tabs-scroll {
    display: flex;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 1rem 0;
    gap: 0.5rem;
    scroll-behavior: smooth;
  }

  .category-tabs-scroll::-webkit-scrollbar {
    display: none;
  }

  .nav-shadow {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 40px;
    pointer-events: none;
    z-index: 2;
  }

  .nav-shadow.right {
    right: 0;
    background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.9));
  }

  .category-tab {
    flex-shrink: 0;
    padding: 0.875rem 1.75rem;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.875rem;
    color: #78350f;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    position: relative;
    overflow: hidden;
  }

  .category-tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f59e0b, #ea580c);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1;
  }

  .category-tab:hover {
    background: rgba(254, 243, 199, 0.5);
    border-color: #f59e0b;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.15);
  }

  .category-tab.active {
    background: linear-gradient(135deg, #f59e0b, #ea580c);
    color: white;
    border-color: transparent;
    box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
    transform: translateY(-2px);
  }

  .category-tab.active::before {
    opacity: 1;
  }

  .tab-content {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .items-count {
    font-size: 0.75rem;
    opacity: 0.7;
    font-weight: 500;
  }

  .category-tab.active .items-count {
    opacity: 0.9;
  }

  .active-category-indicator {
    position: absolute;
    bottom: 0;
    height: 3px;
    background: linear-gradient(90deg, #f59e0b, #ea580c);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 51;
    border-radius: 3px 3px 0 0;
    opacity: 0;
  }

  /* Contenido de categorías */
  .categories-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem 1rem;
    scroll-behavior: smooth;
  }

  .category-section {
    display: none;
    animation: fadeInSlideUp 0.5s ease-out;
  }

  .category-section.active {
    display: block;
  }

  @keyframes fadeInSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .category-header {
    margin-bottom: 2.5rem;
  }

  .category-decoration {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .decoration-line {
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, transparent, #f59e0b, transparent);
    max-width: 100px;
  }

  .category-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .category-title {
    font-family: 'Playfair Display', serif;
    font-size: 2.25rem;
    font-weight: 900;
    color: #78350f;
    margin: 0;
    text-align: center;
    position: relative;
    padding: 0 1rem;
  }

  .category-badge {
    background: rgba(245, 158, 11, 0.1);
    color: #92400e;
    padding: 0.25rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  /* Grid de items del menú */
  .menu-items-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    max-width: 900px;
    margin: 0 auto;
  }

  /* Tarjetas de items */
  .menu-item-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 
      0 2px 8px rgba(0, 0, 0, 0.04),
      0 1px 3px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    transform: translateY(10px);
    position: relative;
    overflow: hidden;
  }

  .menu-item-card.animated {
    animation: cardEntrance 0.6s ease-out forwards;
  }

  @keyframes cardEntrance {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .menu-item-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #f59e0b, #ea580c);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
  }

  .menu-item-card:hover {
    box-shadow: 
      0 8px 30px rgba(0, 0, 0, 0.12),
      0 4px 12px rgba(245, 158, 11, 0.1);
    transform: translateY(-4px);
    border-color: rgba(245, 158, 11, 0.3);
  }

  .menu-item-card:hover::before {
    transform: scaleX(1);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .item-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.375rem;
    font-weight: 700;
    color: #1f2937;
    flex: 1;
    line-height: 1.4;
    margin: 0;
  }

  .item-price-group {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .price-main {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .item-price-crc {
    font-size: 1.375rem;
    font-weight: 800;
    color: #ea580c;
    white-space: nowrap;
    background: linear-gradient(135deg, #ea580c, #dc2626);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .price-alt {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .item-price-usd {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #6b7280;
    white-space: nowrap;
    padding: 0.125rem 0.5rem;
    background: rgba(107, 114, 128, 0.1);
    border-radius: 4px;
  }

  .item-description {
    color: #4b5563;
    line-height: 1.6;
    font-size: 0.9375rem;
    margin: 0 0 1.25rem 0;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .popular-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: rgba(245, 158, 11, 0.1);
    color: #92400e;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid rgba(245, 158, 11, 0.2);
  }

  .star-icon {
    width: 12px;
    height: 12px;
    color: #f59e0b;
  }

  .add-to-order {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f59e0b, #ea580c);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  .add-to-order:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
  }

  .add-to-order:active {
    transform: scale(0.95);
  }

  .plus-icon {
    width: 18px;
    height: 18px;
    stroke-width: 2.5;
  }

  /* Responsive Design */
  @media (min-width: 640px) {
    .menu-items-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .category-tabs-scroll {
      gap: 0.75rem;
      padding: 1.25rem 0;
    }
    
    .category-tab {
      padding: 1rem 2rem;
      font-size: 0.9375rem;
    }
    
    .categories-content {
      padding: 2rem 1.5rem;
    }
  }

  @media (min-width: 768px) {
    .menu-container {
      border-radius: 20px;
      margin: 1rem;
      height: calc(100vh - 2rem);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }
    
    .category-title {
      font-size: 2.75rem;
    }
    
    .menu-items-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
    
    .category-tabs-scroll {
      justify-content: center;
      gap: 1rem;
    }
    
    .categories-content {
      padding: 3rem 2rem;
    }
    
    .decoration-line {
      max-width: 150px;
    }
  }

  @media (min-width: 1024px) {
    .menu-items-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .category-tab {
      font-size: 1rem;
      padding: 1.125rem 2.25rem;
    }
    
    .category-title {
      font-size: 3rem;
    }
  }

  @media (min-width: 1280px) {
    .menu-items-grid {
      grid-template-columns: repeat(4, 1fr);
      max-width: 1200px;
    }
  }

  /* Animaciones para scroll */
  @media (prefers-reduced-motion: reduce) {
    .menu-item-card,
    .category-section,
    .category-tab,
    .active-category-indicator {
      transition: none !important;
      animation: none !important;
    }
  }
</style>
